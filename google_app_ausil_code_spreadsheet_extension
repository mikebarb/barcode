// Google Apps Script Code
// At the TOP of your script, define your spreadsheet ID
const SPREADSHEET_ID = '1CbLT8fYvRl_avdpGiSXzTKyaEuSgV55f4ZXCTJv-aME'; // Your actual ID here
// FIXED: Use explicit spreadsheet ID
//const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
//const sheet = spreadsheet.getSheetByName('Transactions');
const headerNames = ["date - time", "sale type", "email", "name", "comment","ausid barcode", "quantity", "cost", "consignment", "description"];


function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('ðŸš€ My Tools')
    .addItem('Summarise Consignments', 'processData')
    .addToUi();
}

function processData(){
  //const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
  //const sheet = spreadsheet.getSheetByName("transactions");
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getSheetByName("transactions");
  const sheetData = sheet.getDataRange().getValues();

  // Need some ancilary data from the stock/taken list.
  const sheetTaken = spreadsheet.getSheetByName("taken");
  const sheetTakenData = sheetTaken.getDataRange().getValues();
  var takenConsignment = {};
  var takenDescription = {};
  sheetTakenData.forEach(entry =>{
    takenConsignment[entry[0]] = entry[3];
    takenDescription[entry[0]] = entry[1];
  });

  // Remove header
  sheetData.shift();                  // remove title row

  // Add ancillary data to each row for use in this function.
  sheetData.forEach(entry =>{
    var entryCode = entry[5];
    var entryConsignment = takenConsignment[entryCode] || "unknown";
    var entryDescription = takenDescription[entryCode] || "";
    entry.push(entryConsignment);
    entry.push(entryDescription);
  });

  // step through each transaction
  //var processCategories = ["ministry", "cash"];
  // Let's find all the categories from the sheet
  var processCategories = [];
  var processCategoryConsignment = {};
  sheetData.forEach(item =>{
    var itemCode = item[5];
    if (itemCode != "Discount") {
      var itemCategory = item[1];
      var itemConsignment = item[8];
      if (!processCategories.includes(itemCategory)) {
        processCategories.push(itemCategory);
        processCategoryConsignment[itemCategory] = [itemConsignment];
      }else{
        if(!processCategoryConsignment[itemCategory].includes(itemConsignment)){
          processCategoryConsignment[itemCategory].push(itemConsignment);
        }
      }
    }
  });
  //console.log("processCategories",processCategories);
  //console.log("processCategoryConsignment", processCategoryConsignment);

  // IN the Ausil office, PR and Ministy generate one invoice sheet each.
  // All the other categories are invoice by consignment within each category.
  
  // Diagnostics Only - copy of transaction sheet with consignment and description acded.
  // Delete old sheet and create a new one with headers.
  var sheetName1 = "copy_transaction";
  var processSheet1 = spreadsheet.getSheetByName(sheetName1);
  if (processSheet1){
    spreadsheet.deleteSheet(processSheet1);
  }
  processSheet1 = spreadsheet.insertSheet(sheetName1);
  processSheet1.appendRow(headerNames);    // add a header

  sheetData.forEach(entry =>{
      processSheet1.appendRow(entry);
  });

  // Underline this last row.
  var lastRow = processSheet1.getLastRow();
  var lastColumn = processSheet1.getLastColumn();
  if (lastRow > 0 && lastColumn > 0) {
    var lastRowRange = processSheet1.getRange(lastRow, 1, 1, lastColumn);
    // Add bottom border (underline)
    lastRowRange.setBorder(null, null, true, null, null, null, 'black', SpreadsheetApp.BorderStyle.SOLID);
  }

  // Now for the real processing - generating new sheets to match
  processCategories.forEach(processCategory => {
    var sheetName = "";
    if(processCategory == "ministry" || processCategory == "pr"){
      // just process this category without taking notice of consignments.
      sheetName = processCategory;
      processSheet(spreadsheet, sheetName, processCategory, "ANY", sheetData, takenConsignment, takenDescription, processSheet1);
    }else{
      // need to separate out consignments
      processCategoryConsignment[processCategory].forEach(thisConsignment=>{
        sheetName = processCategory + "_" + thisConsignment;
        processSheet(spreadsheet, sheetName, processCategory, thisConsignment, sheetData, takenConsignment, takenDescription, processSheet1);
      });
    }
  });
}

function processSheet(spreadsheet, sheetName, processCategory, processConsignment, sheetData, takenConsignment, takenDescription, processSheet1){
  //console.log("====================================================");
  //console.log("processCategory: " + processCategory + " processConsignment: " + processConsignment);
  //console.log("====================================================");    
  // Delete old sheet and create a new one with headers.
  var processSheet = spreadsheet.getSheetByName(sheetName);
  if (processSheet){
    spreadsheet.deleteSheet(processSheet);
  }
  processSheet = spreadsheet.insertSheet(sheetName);
  processSheet.appendRow(headerNames);    // add a header
  var total = 0;
  var items = {};
  var itemsValue = {};
  sheetData.forEach(entry =>{
    //console.log("entry: ", entry);
    var entryCode = entry[5];
    var entryConsignment = entry[8];
    var entryCategory = entry[1];
    var flagMatchConsignment = false;
    var flagMatchCategory = false;
    (entryCategory == processCategory) ? flagMatchCategory = true : false;
    ((entryConsignment && (entryConsignment == processConsignment)) || (processConsignment == "")) ? flagMatchConsignment = true : false;
    if (processConsignment == "ANY") flagMatchConsignment = true;
    //console.log("***itemCategory: " + entryCategory + " itemConsignment: " + entryConsignment);
    //console.log("flagMatchCategory: " + flagMatchCategory + " flagMatchConsignment: " + flagMatchConsignment);
    if(flagMatchCategory && flagMatchConsignment){
      //console.log("###itemCategory: " + entryCategory + " itemConsignment: " + entryConsignment);
      processSheet1.appendRow(entry);      // Diagnostics
      //console.log (processCategory, entry);
      var itemCode = entry[5];
      var itemQuantity = entry[6];
      var itemTotal = entry[7];
      if (items[itemCode]){
        items[itemCode] += itemQuantity;
        itemsValue[itemCode] = itemTotal;
      }else{
        items[itemCode] = itemQuantity;
        itemsValue[itemCode] = itemTotal;
      }
      processSheet.appendRow(entry);
      total = total + itemTotal;
    }
  });
  // Underline this last row.
  var lastRow = processSheet.getLastRow();
  var lastColumn = processSheet.getLastColumn();
  if (lastRow > 0 && lastColumn > 0) {
    var lastRowRange = processSheet.getRange(lastRow, 1, 1, lastColumn);
    // Add bottom border (underline)
    lastRowRange.setBorder(null, null, true, null, null, null, 'black', SpreadsheetApp.BorderStyle.SOLID);
  }
  // Attach summary details - the critical bit.
  for (const [key, value] of Object.entries(items).sort()) {
    // key = code, value = quantity of this item sold
    var itemTotal = value * itemsValue[key];
    processSheet.appendRow(["", "", "", "", "", key, value, itemTotal]);
  }
  processSheet.appendRow(["", "", "", "", "", "TOTAL", "", total]);
  formatSheet(processSheet);
  formatSheet(processSheet1);
}

function formatSheet(sheet){
  sheet.getRange('H:H').setNumberFormat('$#,##0.00');
  sheet.getRange('G:G').setHorizontalAlignment('center');
  sheet.getRange('I:I').setHorizontalAlignment('center');
  // Underline first row.
  //var lastRow = processSheet.getLastRow();
  var lastColumn = sheet.getLastColumn();
  if (lastColumn > 0) {
    var firstRowRange = sheet.getRange(1, 1, 1, lastColumn);
    // Add bottom border (underline)
    firstRowRange.setBorder(null, null, true, null, null, null, 'black', SpreadsheetApp.BorderStyle.SOLID);
    firstRowRange.setFontWeight('bold');
    for (var i = 1; i <= lastColumn; i++) {
      sheet.autoResizeColumn(i);
    }
  }
}




